<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PADL â€“ Tap to Connect Demo</title>
<style>
  :root { --green:#00ff66; --bg:#0b0b0b; --text:#e7ffe7; }
  * { box-sizing: border-box; }
  body {
    margin:0; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center;
    background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  }
  .card {
    width:min(520px, 92vw); background:#111; border:1px solid #1e1e1e; border-radius:14px; padding:18px 18px 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.45);
  }
  h1 { margin:6px 0 2px; font-size:22px; }
  p { margin:6px 0 12px; opacity:.85; line-height:1.35; }
  .row { display:flex; gap:10px; align-items:center; margin:10px 0 16px; }
  input[type="text"] {
    flex:1; padding:12px 14px; border-radius:10px; border:1px solid #2a2a2a; background:#0d0d0d; color:var(--text);
    outline:none; font-size:16px;
  }
  button {
    padding:12px 16px; border-radius:10px; border:0; font-weight:600; cursor:pointer; font-size:16px;
  }
  .btn-primary { background: var(--green); color:#0c1a10; }
  .btn-ghost { background:#171717; color:var(--text); border:1px solid #2a2a2a; }
  .radar-wrap { display:flex; justify-content:center; margin:18px 0; }
  .radar {
    position:relative; width:220px; height:220px; border-radius:50%;
    background: radial-gradient( circle, rgba(0,255,102,0.10) 0%, rgba(0,255,102,0.06) 40%, rgba(0,255,102,0.02) 70%, transparent 72% );
    overflow:hidden; border:1px solid rgba(0,255,102,0.25);
  }
  .dot {
    position:absolute; top:50%; left:50%; width:14px; height:14px; border-radius:50%; transform:translate(-50%,-50%);
    background: var(--green); box-shadow: 0 0 18px rgba(0,255,102,0.8), 0 0 36px rgba(0,255,102,0.5);
  }
  .pulse, .pulse2, .pulse3 {
    position:absolute; top:50%; left:50%; width:20px; height:20px; border-radius:50%;
    border:2px solid rgba(0,255,102,0.45); transform:translate(-50%,-50%) scale(1); opacity:.9;
    animation: pulse 2.2s ease-out infinite;
  }
  .pulse2 { animation-delay:.55s; opacity:.65; }
  .pulse3 { animation-delay:1.1s; opacity:.45; }
  @keyframes pulse {
    0%   { transform:translate(-50%,-50%) scale(1); opacity:.9; }
    90%  { opacity:0; }
    100% { transform:translate(-50%,-50%) scale(10); opacity:0; }
  }
  .muted { opacity:.7; font-size:13px; }
  .status { margin:8px 0 0; font-weight:600; }
  .ok { color:var(--green); }
  .warn { color:#ffbf3d; }
  .err { color:#ff6464; }
  .row-btns { display:flex; gap:10px; }
</style>
</head>
<body>
<div class="card">
  <h1>PADL â€” Paddle Tap Demo</h1>
  <p>Open this page on <b>two phones</b>. Enter the <b>same room code</b>, both press <b>Tap to Connect</b> within ~3 seconds. Youâ€™ll get green bloops âžœ <b>Connected!</b></p>

  <div class="row">
    <input id="room" type="text" placeholder="Room code (e.g., PADL7)" />
    <button id="join" class="btn-ghost">Join Room</button>
  </div>

  <div class="radar-wrap">
    <div class="radar">
      <div class="dot"></div>
      <div class="pulse"></div>
      <div class="pulse2"></div>
      <div class="pulse3"></div>
    </div>
  </div>

  <div class="row row-btns">
    <button id="tap" class="btn-primary">Tap to Connect</button>
    <button id="reset" class="btn-ghost">Reset</button>
  </div>

  <p id="info" class="muted">Not joined yet.</p>
  <p id="status" class="status"></p>
</div>

<!-- Supabase JS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ðŸ”§ Replace these with your Supabase project values:
  const SUPABASE_URL = "https://aarecaahshiwdqiazlim.supabase.co";            // e.g. https://abcd.supabase.co
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhcmVjYWFoc2hpd2RxaWF6bGltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MjA3MDEsImV4cCI6MjA3MTk5NjcwMX0.8nQEnuERFnvx1wgLwjuA36awW3k4vmITGBtBQPxwB5I";  // anon public key (not the service role)

  const clientIdKey = "padl_client_id";
  let clientId = localStorage.getItem(clientIdKey);
  if (!clientId) {
    clientId = Math.random().toString(36).slice(2, 10);
    localStorage.setItem(clientIdKey, clientId);
  }

  const qs = new URLSearchParams(location.search);
  const $room = document.getElementById("room");
  const $join = document.getElementById("join");
  const $tap = document.getElementById("tap");
  const $reset = document.getElementById("reset");
  const $info = document.getElementById("info");
  const $status = document.getElementById("status");

  // Prefill room from URL if present
  if (qs.get("room")) $room.value = qs.get("room");

  // Setup Supabase
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let channel = null;
  let joined = false;
  let lastTapTime = null;
  let connected = false;

  function setStatus(msg, cls) {
    $status.textContent = msg || "";
    $status.className = "status " + (cls || "");
  }
  function setInfo(msg) { $info.textContent = msg; }

  async function joinRoom(roomCode) {
    if (!roomCode) {
      setStatus("Enter a room code to join.", "warn");
      return;
    }
    if (channel) await supabase.removeChannel(channel);

    channel = supabase.channel("padl-" + roomCode, {
      config: { broadcast: { ack: true }, presence: { key: clientId } }
    });

    channel.on("broadcast", { event: "tap" }, ({ payload }) => {
      if (connected) return;         // already done
      if (!lastTapTime) return;      // we haven't tapped yet
      if (payload.id === clientId) return; // ignore our own
      const now = Date.now();
      const delta = Math.abs(now - lastTapTime);
      if (delta <= 3000) {
        // Other phone tapped within ~3s of our tap
        doConnected();
      }
    });

    channel.on("presence", { event: "sync" }, () => {
      const members = channel.presenceState();
      const count = Object.keys(members).length;
      setInfo(`Joined "${roomCode}". Devices in room: ${count}`);
    });

    await channel.subscribe(async (status) => {
      if (status === "SUBSCRIBED") {
        joined = true;
        setStatus("Ready. Tap to connect when both phones are joined.", "ok");
        channel.track({ joined_at: new Date().toISOString() });
      }
    });
  }

  function pulseActive(on=true) {
    // (visuals run continuously; you can add extra visual states here if you want)
  }

  function doConnected() {
    connected = true;
    pulseActive(false);
    setStatus("âœ… Players Connected!", "ok");
    $tap.disabled = true;
  }

  async function sendTap() {
    if (!joined) {
      setStatus("Join a room first.", "warn");
      return;
    }
    lastTapTime = Date.now();
    setStatus("Listening for the other tapâ€¦", "warn");
    pulseActive(true);
    // auto-cancel listening if no partner taps in time
    setTimeout(() => {
      if (!connected) setStatus("No match yet. Try tapping together again.", "warn");
    }, 3200);

    await channel.send({
      type: "broadcast",
      event: "tap",
      payload: { id: clientId, ts: lastTapTime }
    });
  }

  $join.addEventListener("click", () => {
    const rc = $room.value.trim() || ("PADL" + Math.floor(Math.random()*900 + 100));
    $room.value = rc;
    const url = new URL(location.href);
    url.searchParams.set("room", rc);
    history.replaceState({}, "", url.toString());
    joinRoom(rc);
  });

  $tap.addEventListener("click", sendTap);
  $reset.addEventListener("click", () => {
    connected = false; lastTapTime = null; $tap.disabled = false;
    setStatus("Reset. Tap again when ready.");
  });

  // Auto-join on load if room param exists
  if ($room.value) joinRoom($room.value);
</script>
</body>
</html>
